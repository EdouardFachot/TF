---
title: "group_project1"
author: "Annabelle Frin"
date: "17/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(rgdal)
library(sp)
library(maptools)
library("rgdal")
library("lattice")
library(geosphere)
```


```{r}
#train <- read.csv("train.csv", sep = ",")
#test <- read.csv("data/test.csv", sep = ",")
#head(train)
test=train_000

```

```{r}



shpurl <- "https://www1.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_13a.zip"

tmp    <- tempfile(fileext=".zip")
download.file(shpurl, destfile=tmp)
files <- unzip(tmp, exdir=getwd())



# Load & plot shapefile
shp <- readShapePoly(files[grep(".shp$", files)])

# Load & plot shapefile
shp <- readShapePoly(files[grep(".shp$", files)])
### read shapefile
shp <- readOGR("nybb_13a", "nybb")
proj4string(shp) 

cord.dec = SpatialPoints(cbind(test$pickup_longitude, test$pickup_latitude), proj4string = CRS("+proj=longlat"))


cord.UTM <- spTransform(cord.dec, CRS(proj4string(shp)))
cord.UTM

cord <- data.frame(cord.UTM@coords, id="A", stringsAsFactors=F)

cord2 <- cord

shpurl <- "https://www1.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_13a.zip"
tmp    <- tempfile(fileext=".zip")
download.file(shpurl, destfile=tmp)
files <- unzip(tmp, exdir=getwd())



coordinates(cord) <- ~ coords.x1 + coords.x2
proj4string(cord) <- proj4string(shp)

cord@coords

### SpatialGrid object
bb <- bbox(shp)
cellsize <- c(3.28084, 3.28084)*200  # cell size 1000m
                                # 1 ft = 3.28084 m
cc <- bb[, 1] + (cellsize/2)  # cell offset
cd <- ceiling(diff(t(bb))/cellsize)  # number of cells per direction
grd <- GridTopology(cellcentre.offset=cc, cellsize=cellsize, cells.dim=cd)

spatial_grid <- SpatialGridDataFrame(grd,
                               data=data.frame(id=1:prod(cd)),
                               proj4string=CRS(proj4string(shp)))   

spplot(spatial_grid, "id",
       panel = function(...) {
         panel.gridplot(..., border="black")
         sp.polygons(shp)
         
       })
over(cord, spatial_grid)
summary(over(cord, spatial_grid))





# Plot coordinates
plot(shp)
points(cord2$coords.x1, cord2$coords.x2, pch=19, col="red")
```

```{r}
over_2 <- function (long, lat, grid) {
  cord.dec = SpatialPoints(cbind(long, lat), proj4string = CRS("+proj=longlat"))
  cord.UTM <- spTransform(cord.dec, CRS(proj4string(shp)))
  cord <- data.frame(cord.UTM@coords, id="A", stringsAsFactors=F)
  cord2 <- cord
  coordinates(cord) <- ~ long + lat
  proj4string(cord) <- proj4string(shp)

  return(over(cord,grid))
}


```


```{r}

transformation <- function (list,grid){
  
  #We want to clean the data in order to use it efficiently late. 
  
  #Calling the variables
  key <- as.character(list[3])
  price <- as.numeric(list[2])
  long1 <- as.numeric(list[4])
  lat1 <- as.numeric(list[5])
  long2 <-as.numeric( list[6])
  lat2 <- as.numeric(list[7])
  passenger <- as.numeric(list[8])
  
  #Retrieving the day and the hour
  day <- as.numeric(substr(key,9,10))
  hour <- as.numeric(substr(key,12,13))
  
  
  #Transforming the coords in UTM
  cord.dec_1 = SpatialPoints(cbind(long1, lat1), proj4string = CRS("+proj=longlat"))
  cord.UTM_1 <- spTransform(cord.dec_1, CRS(proj4string(shp)))
  cord_1 <- data.frame(cord.UTM_1@coords, stringsAsFactors=F)
  cord_1_a <- data.frame(cord.UTM_1@coords, id="A", stringsAsFactors=F)
  coordinates(cord_1_a) <- ~ long1 + lat1
  proj4string(cord_1_a) <- proj4string(shp)
  
  cord.dec_2 = SpatialPoints(cbind(long2, lat2), proj4string = CRS("+proj=longlat"))
  cord.UTM_2 <- spTransform(cord.dec_2, CRS(proj4string(shp)))
  cord_2 <- data.frame(cord.UTM_2@coords, stringsAsFactors=F)
  cord_2_a <- data.frame(cord.UTM_2@coords, id="A", stringsAsFactors=F)
  coordinates(cord_2_a) <- ~ long2 + lat2
  proj4string(cord_2_a) <- proj4string(shp)
  
  
  #Getting the id of the different squares
  idp <- over(cord_1_a,grid)
  idd <- over(cord_2_a,grid)
  
  
  
  return(c(#cord_1[1],cord_1[2],cord_2[1],cord_2[2], #if we also want the UTM coords
    
    long1,lat1,long2,lat2,
    
    idp,idd,day,hour,price,passenger))
  
  
  
}

transformation(test[2,],spatial_grid)



```

```{r}
library(tidyverse)
library(purrr)


good_dataframe<-function(df,grid){
  
  #creates a whole dataframe with clean data
  
  map_df(df,~transformation(.x),grid)
  
  
}

good_dataframe(test,spatial_grid)
  
  
  


```



